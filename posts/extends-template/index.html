<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.6.2"><meta name="generator" content="Jekyll v4.1.1" /><meta property="og:title" content="Azure DevOps: Extends Template with Build and Deployment Templates" /><meta name="author" content="Joshua Johanning" /><meta property="og:locale" content="en_US" /><meta name="description" content="Scenario" /><meta property="og:description" content="Scenario" /><link rel="canonical" href="https://josh-ops.com/posts/extends-template/" /><meta property="og:url" content="https://josh-ops.com/posts/extends-template/" /><meta property="og:site_name" content="josh-ops" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-12-10T22:00:00-06:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Azure DevOps: Extends Template with Build and Deployment Templates" /><meta name="twitter:site" content="@jjjettrain" /><meta name="twitter:creator" content="@Joshua Johanning" /><meta name="google-site-verification" content="google-site-verification=eTIC71VhPBtwll8rNv7qlXud1yJh6E88No39MdcM_MI" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Joshua Johanning"},"description":"Scenario","url":"https://josh-ops.com/posts/extends-template/","@type":"BlogPosting","headline":"Azure DevOps: Extends Template with Build and Deployment Templates","dateModified":"2021-01-17T17:12:16-06:00","datePublished":"2020-12-10T22:00:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://josh-ops.com/posts/extends-template/"},"@context":"https://schema.org"}</script><title>Azure DevOps: Extends Template with Build and Deployment Templates | josh-ops</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-GE92ZJY22K"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-GE92ZJY22K'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/sample/headshot.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">josh-ops</a></div><div class="site-subtitle font-italic">A DevOps Blog</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/soccerjoshj07" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/jjjettrain" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['jjohanning','uwalumni.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Azure DevOps: Extends Template with Build and Deployment Templates</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Azure DevOps: Extends Template with Build and Deployment Templates</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Dec 10, 2020, 10:00 PM -0600" > Dec 10, 2020 <i class="unloaded">2020-12-10T22:00:00-06:00</i> </span> by <span class="author"> Joshua Johanning </span></div><div> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Jan 17, 2021, 5:12 PM -0600" > Jan 17 <i class="unloaded">2021-01-17T17:12:16-06:00</i> </span></div></div><div class="post-content"><h2 id="scenario">Scenario</h2><p>I had a client that wanted to integrate a secret scanning utility (among other checks) into the pipeline, and enforce this control. Colin Dembovsky (my co-worker) and I typically recommend creating and referencing job templates for each environment. Job templates are very flexible, allowing for re-use across an organization but still allowing for differences between applications through the parameters passed into the template.</p><p>A very abbreviated example of this would look like:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="na">resources</span><span class="pi">:</span>
  <span class="na">repositories</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">repository</span><span class="pi">:</span> <span class="s">templates</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">github</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">soccerjoshj07/pipeline-templates</span>
    <span class="na">endpoint</span><span class="pi">:</span> <span class="s">soccerjoshj07</span>

<span class="na">stages</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Build'</span>
  <span class="na">jobs</span><span class="pi">:</span> 
  <span class="pi">-</span> <span class="na">template</span><span class="pi">:</span> <span class="s">build.yml@templates</span>
    <span class="na">parameters</span><span class="pi">:</span>
      <span class="na">buildConfiguration</span><span class="pi">:</span> <span class="s1">'</span><span class="s">release'</span>
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">deployDev</span>
  <span class="na">jobs</span><span class="pi">:</span> 
  <span class="pi">-</span> <span class="na">template</span><span class="pi">:</span> <span class="s">deploy.yml@templates</span>
    <span class="na">parameters</span><span class="pi">:</span>
      <span class="na">environment</span><span class="pi">:</span> <span class="s1">'</span><span class="s">dev'</span>
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">deployProd</span>
  <span class="na">jobs</span><span class="pi">:</span> 
  <span class="pi">-</span> <span class="na">template</span><span class="pi">:</span> <span class="s">deploy.yml@templates</span>
    <span class="na">parameters</span><span class="pi">:</span>
      <span class="na">environment</span><span class="pi">:</span> <span class="s1">'</span><span class="s">prod'</span>
</pre></table></code></div></div><p>However, there is nothing here that <em>enforces</em> a developer to use these templates - they could either write their own or just create their pipeline inline. This is where <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/security/templates?view=azure-devops#use-extends-templates">Extends</a> comes into play!</p><p>I remember when this was first announced in a <a href="https://docs.microsoft.com/en-us/azure/devops/release-notes/2019/sprint-162-update#use-extends-keyword-in-pipelines">sprint release note</a> in December 2019, we tried it and couldn’t really get it to work the way we wanted to. But with the client’s requirements, this seemed like a perfect time to give it another shot. I wanted to reference a separate configuration repository where the secret scanning config would be stored without the developer having to worry or care about it, and we found a way to do just that using Extends.</p><h2 id="the-code">The Code</h2><p>In this demo scenario, my code is stored in GitHub, but this could work just as well with code in Azure Repos as well.</p><h3 id="azure-pipelinesyml"><a href="https://github.com/soccerjoshj07/secrets-scanning-poc/blob/f07a2eae415f38933f506d4ed0c69f75df2ffb91/azure-pipelines.yml"><code class="language-plaintext highlighter-rouge">azure-pipelines.yml</code></a></h3><p>In the root <code class="language-plaintext highlighter-rouge">azure-pipelines.yml</code> file, you’ll notice that the <code class="language-plaintext highlighter-rouge">extends</code> keyword is at the same level as <code class="language-plaintext highlighter-rouge">trigger</code> and <code class="language-plaintext highlighter-rouge">resources</code>. This was the tricky part - how does one use <code class="language-plaintext highlighter-rouge">extends</code> AND job templates? The approach is to use a <em>steps</em> template for the build where we want the extra steps injected, and for deployment we can use our <em>job</em> templates like normal. We will add an Environment check that ensures that the extends template is being used. If the Extends template isn’t used, the check fails and the deployment isn’t allowed.</p><p>The deployment stages and jobs are defined in this file as well - this should look very familiar to regular deployment jobs except that they are being referenced as a parameter.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="na">trigger</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">main</span>
  
<span class="na">resources</span><span class="pi">:</span>
  <span class="na">repositories</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">repository</span><span class="pi">:</span> <span class="s">templates</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">github</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">soccerjoshj07/pipeline-templates</span>
    <span class="na">endpoint</span><span class="pi">:</span> <span class="s">soccerjoshj07</span>

<span class="na">extends</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span> <span class="s">secret-scanning/secret-scanning-extends.yml@templates</span>
  <span class="na">parameters</span><span class="pi">:</span>
    <span class="na">buildSteps</span><span class="pi">:</span>
    <span class="c1"># use steps template for build</span>
    <span class="pi">-</span> <span class="na">template</span><span class="pi">:</span> <span class="s">secret-scanning/sample-build-steps.yml@templates</span>
      <span class="na">parameters</span><span class="pi">:</span>
        <span class="na">whatToBuild</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Hello</span><span class="nv"> </span><span class="s">world'</span>
    <span class="na">deployStages</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">dev</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s">deploy to dev</span>
      <span class="na">jobs</span><span class="pi">:</span> 
      <span class="c1"># use job templates as normal for deployment</span>
      <span class="c1"># bug using github as template repo?: must use ../</span>
      <span class="pi">-</span> <span class="na">template</span><span class="pi">:</span> <span class="s">../secret-scanning/sample-deployment-job.yml@templates</span>
        <span class="na">parameters</span><span class="pi">:</span>
          <span class="na">environment</span><span class="pi">:</span> <span class="s">github-secret-scanning-test-gate-dev</span>
    <span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">prod</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s">deploy to prod</span>
      <span class="na">jobs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">template</span><span class="pi">:</span> <span class="s">../secret-scanning/sample-deployment-job.yml@templates</span>
        <span class="na">parameters</span><span class="pi">:</span>
          <span class="na">environment</span><span class="pi">:</span> <span class="s">github-secret-scanning-test-gate-prod</span>
</pre></table></code></div></div><h3 id="secret-scanning-extendsyml"><a href="https://github.com/soccerjoshj07/pipeline-templates/blob/master/secret-scanning/secret-scanning-extends.yml"><code class="language-plaintext highlighter-rouge">secret-scanning-extends.yml</code></a></h3><p>The <code class="language-plaintext highlighter-rouge">parameters</code> passed into the extends template include a <code class="language-plaintext highlighter-rouge">stepList</code> type for the <code class="language-plaintext highlighter-rouge">buildSteps</code> and a <code class="language-plaintext highlighter-rouge">stageList</code> for the <code class="language-plaintext highlighter-rouge">deployStages</code>.</p><p>The <code class="language-plaintext highlighter-rouge">resource</code> and <code class="language-plaintext highlighter-rouge">- template: secret-scanning-steps.yml</code> here is the configuration repository I was mentioning before. For your use case, you may not need this, you would just need the steps in <code class="language-plaintext highlighter-rouge">- ${{ parameters.buildSteps }}</code>.</p><p>The build stage and job is defined in this file.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="na">parameters</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">buildSteps</span> <span class="c1"># the name of the parameter is buildSteps</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">stepList</span> <span class="c1"># data type is StepList</span>
  <span class="na">default</span><span class="pi">:</span> <span class="pi">[]</span> <span class="c1"># default value of buildSteps</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">deployStages</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">stageList</span>
  <span class="na">default</span><span class="pi">:</span> <span class="pi">[]</span> 

<span class="na">resources</span><span class="pi">:</span>
  <span class="na">repositories</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">repository</span><span class="pi">:</span> <span class="s">secretscanning</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">github</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">soccerjoshj07/secret-scanning-config</span>
    <span class="na">endpoint</span><span class="pi">:</span> <span class="s">soccerjoshj07</span>

<span class="na">stages</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">secure_buildstage</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Secure</span><span class="nv"> </span><span class="s">Build</span><span class="nv"> </span><span class="s">Stage'</span>
  <span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">job</span><span class="pi">:</span> <span class="s">secure_buildjob</span>
    <span class="na">steps</span><span class="pi">:</span>

    <span class="pi">-</span> <span class="na">template</span><span class="pi">:</span> <span class="s">secret-scanning-steps.yml</span>

    <span class="pi">-</span> <span class="s">${{ parameters.buildSteps }}</span>

<span class="pi">-</span> <span class="s">${{ parameters.deployStages }}</span>
</pre></table></code></div></div><h3 id="sample-build-stepsyml"><a href="https://github.com/soccerjoshj07/pipeline-templates/blob/master/secret-scanning/sample-build-steps.yml"><code class="language-plaintext highlighter-rouge">sample-build-steps.yml</code></a></h3><p>Not much crazy here - this is a <em>steps</em> template (as opposed to a <em>job</em> template). This is injected into the extends template in the <code class="language-plaintext highlighter-rouge">- ${{ parameters.buildSteps }}</code> line of code.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="na">parameters</span><span class="pi">:</span>
  <span class="na">whatToBuild</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>

<span class="na">steps</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">script</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">echo "${{ parameters.whatToBuild }}, here is where I do my build!"</span>

</pre></table></code></div></div><h3 id="sample-deployment-jobyml"><a href="https://github.com/soccerjoshj07/pipeline-templates/blob/master/secret-scanning/sample-deployment-job.yml"><code class="language-plaintext highlighter-rouge">sample-deployment-job.yml</code></a></h3><p>This is pretty vanilla as well - this <em>job</em> template is injected into the extends template in the <code class="language-plaintext highlighter-rouge">- ${{ parameters.deployStages }}</code> line of code.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="na">parameters</span><span class="pi">:</span>
  <span class="na">environment</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
  <span class="na">pool</span><span class="pi">:</span> 
    <span class="na">vmImage</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ubuntu-latest'</span>
<span class="na">jobs</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">deployment</span><span class="pi">:</span> <span class="s">deploy</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">deploy</span>
  <span class="na">pool</span><span class="pi">:</span> <span class="s">${{ parameters.pool }}</span>
  <span class="na">environment</span><span class="pi">:</span> <span class="s">${{ parameters.environment }}</span>
  <span class="na">strategy</span><span class="pi">:</span>
    <span class="na">runOnce</span><span class="pi">:</span>
      <span class="na">deploy</span><span class="pi">:</span>
        <span class="na">steps</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">script</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">echo "deploy hello world"</span>
          <span class="na">displayName</span><span class="pi">:</span> <span class="s">deploy</span>
</pre></table></code></div></div><h2 id="configuration-in-azure-devops">Configuration in Azure DevOps</h2><p>The <strong>Required YAML Template</strong> check is added to the environment just as an Approval would be:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/screenshots/2020-12-08-extends-template/required-check.png" alt="Azure DevOps required check" /></p><p><em>Note here if you are storing the code in Azure Repos - the example in this screenshot mentions <code class="language-plaintext highlighter-rouge">project/repository-name</code>. If the repository is in the same project, DO NOT include the project name in the path otherwise it won’t work.</em></p><p>Now, if you try to deploy to an environment while not using this extends template, it fails: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/screenshots/2020-12-08-extends-template/failed-stage.png" alt="failed stage" /></p><p>If you click the 0/1 checks passed, it shows the check that failed and hyperlinks to the checks for that environment: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/screenshots/2020-12-08-extends-template/failed-check.png" alt="failed check" /></p><p>Once you properly use the extends template - success! <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/screenshots/2020-12-08-extends-template/successful-stage.png" alt="successful stage" /></p><h2 id="conclusion-and-next-steps">Conclusion and Next Steps</h2><p>This ‘Required Checks’ concept works really well for environments that are defined ahead of time as a way to manage logical groupings of like deployments and add manual approval points.</p><p>Did you know that you can also add these same type of required checks on Service Connections? Yep! Therefore, you can configure your production Azure Service Connection such that ONLY certain users can make the approval, irregardless of how the environment and pipeline is set up.</p><p>Completing this circle, we can ensure that protected resources in Azure DevOps - environments AND service connections - extend from a particular template, ensuring compliance and standardization across the organization.</p><p>Happy templating!</p><h2 id="updates---jan-5-2020---using-build-job-template-instead-of-build-steps-template">Updates - Jan 5 2020 - Using Build Job template instead of Build Steps template</h2><p>After using the template for a few weeks, I’ve made an update to be able to pass in <em>build jobs</em> instead of <em>build steps</em>. Note that with this template, you can pass in either. I prefer using a separate job under the build stage for the secret scanning bit so I can see what failed - the secret scan or the build.</p><p>I have an input parameter for <code class="language-plaintext highlighter-rouge">buildStageName</code> so that this would still make sense in a scenario where there isn’t a stage named Build, such as in Terraform deployments. By default, the stage will be named build, but it can be optionally overridden (called something like <code class="language-plaintext highlighter-rouge">secret-scanning</code> instead, in the Terraform example).</p><p><strong>secret-scanning-extends.yml:</strong></p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="na">parameters</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">buildSteps</span> <span class="c1"># the name of the parameter is buildSteps</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">stepList</span> <span class="c1"># data type is StepList</span>
  <span class="na">default</span><span class="pi">:</span> <span class="pi">[]</span> <span class="c1"># default value of buildSteps</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">buildJobs</span> <span class="c1"># the name of the parameter is buildSteps</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">jobList</span> <span class="c1"># data type is StepList</span>
  <span class="na">default</span><span class="pi">:</span> <span class="pi">[]</span> <span class="c1"># default value of buildSteps</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">deployStages</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">stageList</span>
  <span class="na">default</span><span class="pi">:</span> <span class="pi">[]</span> 
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">buildStageName'</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
  <span class="na">default</span><span class="pi">:</span> <span class="s1">'</span><span class="s">build'</span>

<span class="na">resources</span><span class="pi">:</span>
  <span class="na">repositories</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">repository</span><span class="pi">:</span> <span class="s">secretscanning</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">github</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">soccerjoshj07/secret-scanning-config</span>
    <span class="na">endpoint</span><span class="pi">:</span> <span class="s">soccerjoshj07</span>

<span class="na">stages</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">${{ parameters.buildStageName }}</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">${{ parameters.buildStageName }}</span>
  <span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">job</span><span class="pi">:</span> <span class="s">secret_scanning</span>
    <span class="na">steps</span><span class="pi">:</span>

    <span class="pi">-</span> <span class="na">template</span><span class="pi">:</span> <span class="s">secret-scanning/secret-scanning-steps.yml</span>

    <span class="pi">-</span> <span class="s">${{ parameters.buildSteps }}</span>

  <span class="pi">-</span> <span class="s">${{ parameters.buildJobs }}</span>

<span class="pi">-</span> <span class="s">${{ parameters.deployStages }}</span>

</pre></table></code></div></div><p><strong>azure-pipelines.yml:</strong></p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="na">trigger</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">main</span>
  
<span class="na">resources</span><span class="pi">:</span>
  <span class="na">repositories</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">repository</span><span class="pi">:</span> <span class="s">templates</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">github</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">soccerjoshj07/pipeline-templates</span>
    <span class="na">endpoint</span><span class="pi">:</span> <span class="s">soccerjoshj07</span>

<span class="na">extends</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span> <span class="s">secret-scanning/secret-scanning-extends.yml@templates</span>
  <span class="na">parameters</span><span class="pi">:</span>
    <span class="na">buildJobs</span><span class="pi">:</span>
    <span class="c1"># job template</span>
    <span class="pi">-</span> <span class="na">template</span><span class="pi">:</span> <span class="s">my-build-job.yml@templates</span>
    <span class="na">deployStages</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">dev</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s">deploy to dev</span>
      <span class="na">jobs</span><span class="pi">:</span> 
      <span class="c1"># job template</span>
      <span class="pi">-</span> <span class="na">template</span><span class="pi">:</span> <span class="s">secret-scanning/sample-deployment-job.yml@templates</span>
        <span class="na">parameters</span><span class="pi">:</span>
          <span class="na">environment</span><span class="pi">:</span> <span class="s">github-secret-scanning-test-gate-dev</span>
    <span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">prod</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s">deploy to prod</span>
      <span class="na">jobs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">template</span><span class="pi">:</span> <span class="s">secret-scanning/sample-deployment-job.yml@templates</span>
        <span class="na">parameters</span><span class="pi">:</span>
          <span class="na">environment</span><span class="pi">:</span> <span class="s">github-secret-scanning-test-gate-prod</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/azure-devops/'>Azure DevOps</a>, <a href='/categories/pipelines/'>Pipelines</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/azure-devops/" class="post-tag no-text-decoration" >Azure DevOps</a> <a href="/tags/pipeline-templates/" class="post-tag no-text-decoration" >Pipeline Templates</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Azure DevOps: Extends Template with Build and Deployment Templates - josh-ops&url=https://josh-ops.com/posts/extends-template/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Azure DevOps: Extends Template with Build and Deployment Templates - josh-ops&u=https://josh-ops.com/posts/extends-template/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Azure DevOps: Extends Template with Build and Deployment Templates - josh-ops&url=https://josh-ops.com/posts/extends-template/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/angular-tokenization/">Tokenizing Angular Environment Configuration in Azure DevOps</a><li><a href="/posts/nuget-pusher-script/">Quickly Migrate NuGet Packages to a New Feed En Masse</a><li><a href="/posts/extends-template/">Azure DevOps: Extends Template with Build and Deployment Templates</a><li><a href="/posts/github-codeql-pr/">GitHub: Block Pull Request if Code Scanning Alerts Are Found</a><li><a href="/posts/authorize-azure-artifacts-in-github-actions/">Authorize and Restore Azure Artifacts NuGet Packages in GitHub Actions</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/github/">GitHub</a> <a class="post-tag" href="/tags/nuget/">NuGet</a> <a class="post-tag" href="/tags/azure-artifacts/">Azure Artifacts</a> <a class="post-tag" href="/tags/codeql/">CodeQL</a> <a class="post-tag" href="/tags/pipeline-templates/">Pipeline Templates</a> <a class="post-tag" href="/tags/pull-requests/">Pull Requests</a> <a class="post-tag" href="/tags/work-items/">Work Items</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/angular-tokenization/"><div class="card-body"> <span class="timeago small" > Jun 17 <i class="unloaded">2021-06-17T18:30:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Tokenizing Angular Environment Configuration in Azure DevOps</h3><div class="text-muted small"><p> Overview I was working with a team that had an Angular front-end application and I was tasked with improving their CI/CD process. They had some automated pipelines, but they were running a build b...</p></div></div></a></div><div class="card"> <a href="/posts/authorize-azure-artifacts-in-github-actions/"><div class="card-body"> <span class="timeago small" > Jan 4 <i class="unloaded">2021-01-04T14:15:00-06:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Authorize and Restore Azure Artifacts NuGet Packages in GitHub Actions</h3><div class="text-muted small"><p> Summary I needed to be able to restore my NuGet packages hosted in an Azure Artifacts instance in a GitHub Action workflow. In Azure Pipelines, it’s relatively simple with the Restore NuGet Packag...</p></div></div></a></div><div class="card"> <a href="/posts/nuget-pusher-script/"><div class="card-body"> <span class="timeago small" > Dec 23, 2020 <i class="unloaded">2020-12-23T16:45:00-06:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Quickly Migrate NuGet Packages to a New Feed En Masse</h3><div class="text-muted small"><p> Summary This is a very simple bash script that can assist you in migrating NuGet packages to a different Artifact feed. It’s written with Azure DevOps in mind as a target, but there’s no reason wh...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled"><p>-</p></span> <a href="/posts/github-codeql-pr/" class="btn btn-outline-primary"><p>GitHub: Block Pull Request if Code Scanning Alerts Are Found</p></a></div><script src="https://utteranc.es/client.js" repo="soccerjoshj07/soccerjoshj07.github.io" issue-term="title" theme="preferred-color-scheme" crossorigin="anonymous" async> </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://github.com/soccerjoshj07">Josh Johanning</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/github/">GitHub</a> <a class="post-tag" href="/tags/nuget/">NuGet</a> <a class="post-tag" href="/tags/azure-artifacts/">Azure Artifacts</a> <a class="post-tag" href="/tags/codeql/">CodeQL</a> <a class="post-tag" href="/tags/pipeline-templates/">Pipeline Templates</a> <a class="post-tag" href="/tags/pull-requests/">Pull Requests</a> <a class="post-tag" href="/tags/work-items/">Work Items</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://josh-ops.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
