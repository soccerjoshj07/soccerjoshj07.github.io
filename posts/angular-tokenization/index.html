<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.6.2"><meta name="generator" content="Jekyll v4.1.1" /><meta property="og:title" content="Tokenizing Angular Environment Configuration in Azure DevOps" /><meta name="author" content="Joshua Johanning" /><meta property="og:locale" content="en_US" /><meta name="description" content="Using the ‘build once deploy many’ concepts with an Angular application and Azure Pipelines" /><meta property="og:description" content="Using the ‘build once deploy many’ concepts with an Angular application and Azure Pipelines" /><link rel="canonical" href="https://josh-ops.com/posts/angular-tokenization/" /><meta property="og:url" content="https://josh-ops.com/posts/angular-tokenization/" /><meta property="og:site_name" content="josh-ops" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-06-17T18:30:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Tokenizing Angular Environment Configuration in Azure DevOps" /><meta name="twitter:site" content="@jjjettrain" /><meta name="twitter:creator" content="@Joshua Johanning" /><meta name="google-site-verification" content="google-site-verification=eTIC71VhPBtwll8rNv7qlXud1yJh6E88No39MdcM_MI" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Joshua Johanning"},"description":"Using the ‘build once deploy many’ concepts with an Angular application and Azure Pipelines","url":"https://josh-ops.com/posts/angular-tokenization/","@type":"BlogPosting","headline":"Tokenizing Angular Environment Configuration in Azure DevOps","dateModified":"2021-06-23T11:18:56-05:00","datePublished":"2021-06-17T18:30:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://josh-ops.com/posts/angular-tokenization/"},"@context":"https://schema.org"}</script><title>Tokenizing Angular Environment Configuration in Azure DevOps | josh-ops</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-GE92ZJY22K"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-GE92ZJY22K'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/sample/headshot.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">josh-ops</a></div><div class="site-subtitle font-italic">A DevOps Blog</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/soccerjoshj07" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/jjjettrain" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['jjohanning','uwalumni.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Tokenizing Angular Environment Configuration in Azure DevOps</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Tokenizing Angular Environment Configuration in Azure DevOps</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Jun 17, 2021, 6:30 PM -0500" > Jun 17 <i class="unloaded">2021-06-17T18:30:00-05:00</i> </span> by <span class="author"> Joshua Johanning </span></div><div> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Jun 23, 2021, 11:18 AM -0500" > Jun 23 <i class="unloaded">2021-06-23T11:18:56-05:00</i> </span></div></div><div class="post-content"><h2 id="overview">Overview</h2><p>I was working with a team that had an Angular front-end application and I was tasked with improving their CI/CD process. They had some automated pipelines, but they were running a build before each environment by running a different <code class="language-plaintext highlighter-rouge">npm run build -- --configuration &lt;env&gt;</code> command.</p><p>My co-worker Colin Dembovsky summarizes it well in a <a href="https://colinsalmcorner.com/managing-config-for-net-core-web-app-deployments-with-tokenizer-and-replacetokens-tasks/">similar post for .NET Core</a>:</p><blockquote><p><strong>The Build Once Principle</strong></p><p>If you’ve ever read any of my blogs you’ll know I’m a proponent of the “build once” principle. That is, your build should be taking source code and (after testing and code analysis etc.) producing a single package that can be deployed to multiple environments. The biggest challenge with a “build once” approach is that it’s non-trivial to manage configuration. If you’re building a single package, how do you deploy it to multiple environments when the configuration is different on those environments?</p></blockquote><p>Basically, if you’re running a new build for each environment, you might as well not do any tests after your Dev build because there’s no way you can guarantee that the binaries build for Dev are the same as the ones going into Production. Never mind that it’s inefficient and wastes time - you already compiled your code once, why do it again? The only things that should differ between environments should be the environment-specific configuration (such as a connection string, or in my case, the back-end API url).</p><p>I’m taking the concepts from that post and my experience with a few other clients and will be doing something very similar to that here!</p><h2 id="the-problem">The Problem</h2><p>The particular challenge with Angular is that the build output is not the same file name every time - you can’t just swap in a new file with the proper values. See screenshot for th main.js files from two builds:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/screenshots/2021-06-17-angular-tokenization/main.js.png" alt="main.js example" /></p><h2 id="solution-and-file-edits">Solution and File Edits</h2><p>We are going to make a few modifications and additions to the Angular code, but most of the changes will come in the pipeline.</p><p>Pre-requisites:</p><ul><li><a href="https://marketplace.visualstudio.com/items?itemName=qetza.replacetokens">Qetza’s Replace Tokens</a> extension installed in the Azure DevOps organization</ul><h3 id="angularjson">angular.json</h3><p>Your <code class="language-plaintext highlighter-rouge">angular.json</code> file might look a little different, but what I did was take an existing configuration, copy/paste it, and change the <code class="language-plaintext highlighter-rouge">fileReplacements</code> section, specifically the <code class="language-plaintext highlighter-rouge">src/environments/environment.tokenized.ts</code> line.</p><p><code class="language-plaintext highlighter-rouge">angular.json</code>:</p><div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="w">          </span><span class="nl">"configurations"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="err">...</span><span class="w">
            </span><span class="nl">"tokenized"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"fileReplacements"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
                </span><span class="nl">"replace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"src/environments/environment.ts"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"with"</span><span class="p">:</span><span class="w"> </span><span class="s2">"src/environments/environment.tokenized.ts"</span><span class="w">
              </span><span class="p">}],</span><span class="w">
              </span><span class="nl">"optimization"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
              </span><span class="nl">"outputHashing"</span><span class="p">:</span><span class="w"> </span><span class="s2">"all"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"sourceMap"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
              </span><span class="nl">"namedChunks"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
              </span><span class="nl">"extractLicenses"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
              </span><span class="nl">"vendorChunk"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
              </span><span class="nl">"buildOptimizer"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
              </span><span class="nl">"budgets"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
                  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"initial"</span><span class="p">,</span><span class="w">
                  </span><span class="nl">"maximumWarning"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2mb"</span><span class="p">,</span><span class="w">
                  </span><span class="nl">"maximumError"</span><span class="p">:</span><span class="w"> </span><span class="s2">"4mb"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w">
                  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"anyComponentStyle"</span><span class="p">,</span><span class="w">
                  </span><span class="nl">"maximumWarning"</span><span class="p">:</span><span class="w"> </span><span class="s2">"100kb"</span><span class="p">,</span><span class="w">
                  </span><span class="nl">"maximumError"</span><span class="p">:</span><span class="w"> </span><span class="s2">"150kb"</span><span class="w">
                </span><span class="p">}</span><span class="w">
              </span><span class="p">]</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h2 id="environmentstokenizedts">environments.tokenized.ts</h2><p>Similarly, I copied an existing <code class="language-plaintext highlighter-rouge">src/environments/environments.*.ts</code> file to create the <code class="language-plaintext highlighter-rouge">environments.tokenized.ts</code> file that my new configuration will use. The important line here is the <code class="language-plaintext highlighter-rouge">baseUrl: '#{baseUrl}#'</code> line. Notice how I’m creating a token here with the <code class="language-plaintext highlighter-rouge">#{token-name}#</code> syntax. This is the syntax of the token that our deployment process will know to find and replace.</p><p><code class="language-plaintext highlighter-rouge">environments.tokenized.ts</code>:</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="p">{</span> <span class="nx">NgxLoggerLevel</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">ngx-logger</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">environment</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">production</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">baseUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">#{baseUrl}#</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">webUrl</span><span class="p">:</span> <span class="nx">location</span><span class="p">.</span><span class="nx">origin</span><span class="p">,</span>
  <span class="na">loggerLevel</span><span class="p">:</span> <span class="nx">NgxLoggerLevel</span><span class="p">.</span><span class="nx">OFF</span>
<span class="p">};</span>
</pre></table></code></div></div><h2 id="azure-pipelinesyml">azure-pipelines.yml</h2><p>Finally, we just need to modify our pipeline file! I’ll break down the changes in chunks.</p><h3 id="1-npm-build">1. NPM Build</h3><p>In the Build job, update the <strong><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/artifacts/npm?view=azure-devops&amp;tabs=yaml">NPM build</a></strong> command. In this example, the command this task will produce will be <code class="language-plaintext highlighter-rouge">npm run build -- --configuration=tokenized</code>. Alternatively, you may just opt to use a <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema?view=azure-devops&amp;tabs=schema%2Cparameter-schema#script">script task</a>, but the <code class="language-plaintext highlighter-rouge">Npm@1</code> task also works.</p><div class="language-yml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">Npm@1</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">npm</span><span class="nv"> </span><span class="s">build"</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">custom</span>
    <span class="na">workingDir</span><span class="pi">:</span> <span class="s">src</span>
    <span class="na">verbose</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">customCommand</span><span class="pi">:</span> <span class="s">run build -- --configuration=tokenized</span>
</pre></table></code></div></div><h3 id="2-add-variables-for-your-tokens">2. Add Variables for your Tokens</h3><p>For each token you have, add a like-named <strong><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema?view=azure-devops&amp;tabs=schema%2Cparameter-schema#variables">variable</a></strong>. The task uses the variable name/value to find/replace in the tokenized file. Here’s an example of setting a variable at the stage level (ie: Deploy to Dev), but the variable could also be scoped at the job level. Just note that the variable is created without the <code class="language-plaintext highlighter-rouge">#{</code> prefix or <code class="language-plaintext highlighter-rouge">}#</code> suffix - in other words, just create the variable as the token name without the wrappings.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">deployDev</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Deploy</span><span class="nv"> </span><span class="s">Dev"</span>
  <span class="na">variables</span><span class="pi">:</span>
    <span class="na">baseUrl</span><span class="pi">:</span> <span class="s">https://mysite-dev.azurewebsites.net/</span>
</pre></table></code></div></div><h3 id="3-extract-files">3. Extract Files</h3><p>I’m assuming your build artifacts are <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema?view=azure-devops&amp;tabs=schema%2Cparameter-schema#publish">published to the Pipeline</a>, which is going to create a zip. In the Deployment job, we need to <strong><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/utility/extract-files?view=azure-devops">unzip the artifact</a></strong> before we can inject the real values in place of the tokens.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">ExtractFiles@1</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Extract</span><span class="nv"> </span><span class="s">files'</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="na">archiveFilePatterns</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(pipeline.workspace)/**/*.zip'</span>
    <span class="na">destinationFolder</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Pipeline.Workspace)/deploy'</span>
</pre></table></code></div></div><ul><li>Unzip Note 1: If you are running on your own ubuntu agents, make sure <code class="language-plaintext highlighter-rouge">unzip</code> is installed first!<li>Unzip Note 2: Similarly, if you are running on your own agents, the above example requires the <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/phases?view=azure-devops&amp;tabs=yaml#workspace">workspace to be cleaned</a> for each run otherwise on the second run it will find more than one .zip file to extract. You could alternatively use a stronger typed pattern than the <code class="language-plaintext highlighter-rouge">**/*.zip</code> pattern in finding your zips, of course.</ul><h3 id="4-replace-tokens">4. Replace Tokens</h3><p>Right after you extract the contents of the artifact zip, add in the <strong><a href="https://marketplace.visualstudio.com/items?itemName=qetza.replacetokens">Replace Tokens</a></strong> task. Note how my <code class="language-plaintext highlighter-rouge">rootDirectory</code> parameter is the same as the <code class="language-plaintext highlighter-rouge">destinationFolder</code> parameter from the unzip task. Additionally, <code class="language-plaintext highlighter-rouge">targetFiles</code> parameter is using a pattern to find the <code class="language-plaintext highlighter-rouge">main*.js</code> file, no matter what the file gets named for each build.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">qetza.replacetokens.replacetokens-task.replacetokens@3</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Replace</span><span class="nv"> </span><span class="s">tokens'</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="na">rootDirectory</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(pipeline.workspace)/deploy'</span>
    <span class="na">targetFiles</span><span class="pi">:</span> <span class="s1">'</span><span class="s">**/main*.js'</span>
    <span class="na">escapeType</span><span class="pi">:</span> <span class="s">none</span>
    <span class="na">verbosity</span><span class="pi">:</span> <span class="s">detailed</span>
</pre></table></code></div></div><ul><li>Replace Tokens Note 1: Normally I don’t use the <em>full</em> name when referencing pipeline tasks, but if you also have <a href="https://marketplace.visualstudio.com/items?itemName=colinsalmcorner.colinsalmcorner-buildtasks">Colin’s ALM Corner Build and Release Tools</a>, you’ll run into an ambiguous task name error.<li>Replace Tokens Note 2: If you opted to not use the default token prefix/suffix like <code class="language-plaintext highlighter-rouge">#{token-name}#</code>, you can add in the <code class="language-plaintext highlighter-rouge">tokenPrefix</code> and <code class="language-plaintext highlighter-rouge">tokenSuffix</code> parameters here as well. Further documentation is <a href="https://github.com/qetza/vsts-replacetokens-task">here</a>.<li>Replace Tokens Note 3: If you had tokens in other .js files, you could simply use a <code class="language-plaintext highlighter-rouge">**/*.js</code> pattern.</ul><h3 id="5-azure-web-app-deploy">5. Azure Web App Deploy</h3><p>Assuming your deploying this <strong><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/azure-rm-web-app?view=azure-devops">Web App to Azure</a></strong>, update your task to use the new folder location <em>instead</em> of the zip package. The input takes either a zip or a folder, so we could have zipped our folder back up after running the replace tokens task, but there is no need. We simply need to use the same path for <code class="language-plaintext highlighter-rouge">package</code> that we used above for <code class="language-plaintext highlighter-rouge">destinationFolder</code> and <code class="language-plaintext highlighter-rouge">rootDirectory</code>.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">AzureWebApp@1</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Deploy</span><span class="nv"> </span><span class="s">Azure</span><span class="nv"> </span><span class="s">Web</span><span class="nv"> </span><span class="s">App'</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="na">azureSubscription</span><span class="pi">:</span> <span class="s">MyAzureSubscription</span>
    <span class="na">appType</span><span class="pi">:</span> <span class="s1">'</span><span class="s">webAppLinux'</span>
    <span class="na">appName</span><span class="pi">:</span> <span class="s">WebAppName</span>
    <span class="na">package</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Pipeline.Workspace)/deploy'</span>
</pre></table></code></div></div><h2 id="summary">Summary</h2><p>The <strong>build job</strong> will use our <code class="language-plaintext highlighter-rouge">tokenized</code> configuration to run the build and use our <code class="language-plaintext highlighter-rouge">#{baseUrl}#</code> token to use when compiling instead of a Dev or Prod URL. When you build locally, you can still use whatever other configuration you want without having to worry about the tokenized value. Just be sure to keep your config in sync, that is if you add or change something to one <code class="language-plaintext highlighter-rouge">environment*.ts</code> file, make sure to remember to do the tokenized one as well.</p><p>The <strong>deployment job</strong> will…</p><ul><li>take your published artifact zip from build<li>extract it<li>use the variable with the same name as the token to inject the value in for the right deployment environment<li>deploy your web app like normal!<li>rinse and repeat for all of your environments</ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/screenshots/2021-06-17-angular-tokenization/replace-tokens.png" alt="Replace Tokens Workflow" /></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/azure-devops/'>Azure DevOps</a>, <a href='/categories/pipelines/'>Pipelines</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/azure-devops/" class="post-tag no-text-decoration" >Azure DevOps</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Tokenizing Angular Environment Configuration in Azure DevOps - josh-ops&url=https://josh-ops.com/posts/angular-tokenization/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Tokenizing Angular Environment Configuration in Azure DevOps - josh-ops&u=https://josh-ops.com/posts/angular-tokenization/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Tokenizing Angular Environment Configuration in Azure DevOps - josh-ops&url=https://josh-ops.com/posts/angular-tokenization/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/angular-tokenization/">Tokenizing Angular Environment Configuration in Azure DevOps</a><li><a href="/posts/nuget-pusher-script/">Quickly Migrate NuGet Packages to a New Feed En Masse</a><li><a href="/posts/extends-template/">Azure DevOps: Extends Template with Build and Deployment Templates</a><li><a href="/posts/github-codeql-pr/">GitHub: Block Pull Request if Code Scanning Alerts Are Found</a><li><a href="/posts/authorize-azure-artifacts-in-github-actions/">Authorize and Restore Azure Artifacts NuGet Packages in GitHub Actions</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/github/">GitHub</a> <a class="post-tag" href="/tags/nuget/">NuGet</a> <a class="post-tag" href="/tags/azure-artifacts/">Azure Artifacts</a> <a class="post-tag" href="/tags/codeql/">CodeQL</a> <a class="post-tag" href="/tags/pipeline-templates/">Pipeline Templates</a> <a class="post-tag" href="/tags/pull-requests/">Pull Requests</a> <a class="post-tag" href="/tags/work-items/">Work Items</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/extends-template/"><div class="card-body"> <span class="timeago small" > Dec 10, 2020 <i class="unloaded">2020-12-10T22:00:00-06:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Azure DevOps: Extends Template with Build and Deployment Templates</h3><div class="text-muted small"><p> Scenario I had a client that wanted to integrate a secret scanning utility (among other checks) into the pipeline, and enforce this control. Colin Dembovsky (my co-worker) and I typically recommen...</p></div></div></a></div><div class="card"> <a href="/posts/authorize-azure-artifacts-in-github-actions/"><div class="card-body"> <span class="timeago small" > Jan 4 <i class="unloaded">2021-01-04T14:15:00-06:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Authorize and Restore Azure Artifacts NuGet Packages in GitHub Actions</h3><div class="text-muted small"><p> Summary I needed to be able to restore my NuGet packages hosted in an Azure Artifacts instance in a GitHub Action workflow. In Azure Pipelines, it’s relatively simple with the Restore NuGet Packag...</p></div></div></a></div><div class="card"> <a href="/posts/nuget-pusher-script/"><div class="card-body"> <span class="timeago small" > Dec 23, 2020 <i class="unloaded">2020-12-23T16:45:00-06:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Quickly Migrate NuGet Packages to a New Feed En Masse</h3><div class="text-muted small"><p> Summary This is a very simple bash script that can assist you in migrating NuGet packages to a different Artifact feed. It’s written with Azure DevOps in mind as a target, but there’s no reason wh...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/trac-to-github/" class="btn btn-outline-primary"><p>So You Want to Migrate Trac Tickets to GitHub Issues</p></a> <span class="btn btn-outline-primary disabled"><p>-</p></span></div><script src="https://utteranc.es/client.js" repo="soccerjoshj07/soccerjoshj07.github.io" issue-term="title" theme="preferred-color-scheme" crossorigin="anonymous" async> </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://github.com/soccerjoshj07">Josh Johanning</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/github/">GitHub</a> <a class="post-tag" href="/tags/nuget/">NuGet</a> <a class="post-tag" href="/tags/azure-artifacts/">Azure Artifacts</a> <a class="post-tag" href="/tags/codeql/">CodeQL</a> <a class="post-tag" href="/tags/pipeline-templates/">Pipeline Templates</a> <a class="post-tag" href="/tags/pull-requests/">Pull Requests</a> <a class="post-tag" href="/tags/work-items/">Work Items</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://josh-ops.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
